#title Editace dynamických práv a menu v databázi

* Přidávání rolí a změny členství

Přidání role se provede vložením řádku do tabulky e_pytis_roles:

<example>
insert into e_pytis_roles (name, description, purposeid)
                   values ('NAME', 'DESCRIPTION', 'PURPOSEID');
</example>

  NAME ... jméno role
  DESCRIPTION ... slovní popis účelu role
  PURPOSEID ... jeden z řetězců `user', `appl', `admn'; viz tabulka c_pytis_role_purposes

Přidání člena role se provede v tabulce `e_pytis_role_members':

<example>
insert into e_pytis_role_members (roleid, member)
                          values ('GROUP', 'MEMBER');
</example>

  GROUP ... role, která má obsahovat MEMBER
  MEMBER ... role, která se má stát členem GROUP


* Přidání akce

Všechny akce jsou evidovány v tabulce `c_pytis_menu_actions'.  Pro každou akci
je potřeba správně zformulovat její identifikátor.  Existují následující druhy
akcí a jejich identifikátorů:

- Příkaz RUN_FORM:

    form/CLASS_NAME/FORM_NAME/COMMAND_PROC/
    form/CLASS_NAME/FORM_NAME/binding=BINDING/COMMAND_PROC/

  CLASS_NAME ... plně kvalifikovaná třída formuláře, např. `pytis.form.BrowseForm'
  FORM_NAME ... specifikace formuláře kvalifikovaná vůči adresáři `defs', např. `misc.Products'
  COMMAND_PROC ... argument `command' nebo prázdné
  BINDING ... binding formuláře

  Pokud je potřeba mít evidovanou formulářovou akci, která je přítomna pouze
  jako specifikace a neexistuje pro ni uživatelská akce, ukládá se ve tvaru

    form/*/FORM_NAME

  Specifikace částí násobných formulářů (podrobněji viz níže) se ukládají ve
  tvaru

    sub/NN/FORM_ACTION

  NN .. dvojciferné pořadové číslo podformuláře, `00' odpovídá vždy hlavnímu formuláři
  FORM_ACTION .. plná specifikace akce násobného formuláře
  
- Příkaz NEW_RECORD:

    NEW_RECORD/NAME/COMMAND_PROC/

  NAME ... argument `name'
  COMMAND_PROC ... argument `command' nebo prázdné 

- Příkaz HANDLED_ACTION:

    handle/NAME/COMMAND_PROC/

  NAME ... plně kvalifikované jméno funkce
  COMMAND_PROC ... argument `command' nebo prázdné

- Příkaz RUN_PROCEDURE:

    proc/PROC_NAME/SPEC_NAME/COMMAND_PROC/

  PROC_NAME ... argument `proc_name'
  SPEC_NAME ... argument `spec_name'
  COMMAND_PROC ... argument `command' nebo prázdné

- Ostatní příkazy:

    COMMAND/COMMAND_PROC

  COMMAND ... název příkazu (např. `EXIT')
  COMMAND_PROC ... argument `command' nebo prázdné

Pokud mají nějaké akce extra argumenty, které nejsou pokryty výše uvedenými
pravidly, je pro ně potřeba vytvořit definici v commands.py.

Zajisté nejjednodušším způsobem, jak správný identifikátor akce vytvořit, je
zkopírovat ho a upravit podle nějaké podobné akce již v tabulce přítomné.
  
Přidání akce se provede takto:

<example>
insert into c_pytis_menu_actions (fullname, shortname, action_title, description)
                          values ('FULLNAME', 'SHORTNAME', 'TITLE', 'DESCRIPTION');
<example>

  FULLNAME ... identifikátor akce vytvořený dle pravidel výše
  SHORTNAME ... pro akce s prefixem `form/' a `sub/' má podobu `form/FORM_NAME'
    pro ostatní akce je shodné s FULLNAME
  TITLE ... libovolný stručný titulek akce, odpovídá atributu `title' ve specifikaci
  DESCRIPTION ... nepovinná poznámka vztahující se k akci, správce DMP ji může
    editovat

** Přidávání akcí násobných formulářů (DualForm a MultiBrowseDualForm)

Pro násobné formuláře je třeba v tabulce `c_pytis_menu_actions' definovat akci
formuláře jako celku a kromě toho akce všech jeho podformulářů (hlavního
i vedlejších).  Formulář jako celek se definuje obvyklým způsobem.  Každý
z podformulářů má akci s fullname prefixem `sub/' ve tvaru popsaném výše,
přičemž hlavní formulář musí mít vždy pořadové číslo `00' a vedlejší formuláře
mají čísla následující, odpovídající pořadí formulářů.  Ve fullname se za
`sub/NN/' uvádí akce celého formuláře (je u všech podformulářů stejná), zatímco
v shortname se uvádí akce odpovídající danému podformuláři.  Příklad akcí
násobného formuláře `menu.ApplicationMenuM':

                                  fullname                                   |             shortname              |       action_title       
-----------------------------------------------------------------------------+------------------------------------+--------------------------
 form/pytis.form.dualform.MultiBrowseDualForm/menu.ApplicationMenuM//        | form/menu.ApplicationMenuM         | Menu
 sub/00/form/pytis.form.dualform.MultiBrowseDualForm/menu.ApplicationMenuM// | form/menu.ApplicationMenuM         | Menu
 sub/01/form/pytis.form.dualform.MultiBrowseDualForm/menu.ApplicationMenuM// | form/menu.ApplicationMenuRights    | Rozpis práv položky menu
 sub/02/form/pytis.form.dualform.MultiBrowseDualForm/menu.ApplicationMenuM// | form/menu.ApplicationSummaryRights | Práva položky menu


* Přidání práv

Práva se evidují v tabulce `e_pytis_action_rights':

<example>
insert into e_pytis_action_rights (shortname, roleid, rightid, system, granted, colname)
                           values ('SHORTNAME', 'ROLE', 'RIGHTID', SYSTEM, GRANTED, COLUMN);
</example>

  SHORTNAME ... stručné jméno akce, která je přítomná v tabulce c_pytis_menu_actions
  ROLE ... role, které se položka týká; `*' značí všechny role
  RIGHTID ... jedna z hodnot klíčového sloupce číselníku `c_pytis_access_rights'
  SYSTEM ... boolean flag určující, zda se jedná o systémové právo
  GRANTED ... boolean flag určující, zda je právo povoleno nebo odepřeno;
    pozor, systémová práva smí být jen povolena
  COLUMN ... jméno sloupce, na který se právo vztahuje (string), nebo NULL
    pokud se vztahuje na všechny sloupce

Poznámka k právům násobných formulářů: Právo násobného formuláře je odvozováno
od práv jeho podformulářů.  Základem jsou práva hlavního podformuláře,
v případě práva VIEW musí být navíc toto povoleno pro aspoň jeden z vedlejších
podformulářů.  Formulář jako celek explicitní vlastní práva nemá, může však
dědit práva z nadřazených položek menu.


* Přidání položky menu

Menu je uloženo v tabulce `e_pytis_menu':

<example>
insert into e_pytis_menu (name, title, position, fullname, help, hotkey, locked) 
                  values ('NAME', 'TITLE', 'POSITION', 'FULLNAME', 'HELP', 'HOTKEY', LOCKED);
</example>

  NAME ... NULL pro podmenu a separátory, unikátní jméno (obvykle ACTION) pro
    koncové položky menu
  TITLE ... titulek menu jak se objeví v uživatelském rozhraní
  POSITION ... pozice v menu jako ltree řetězec skládající se z prefixu
    rodičovského menu, ke kterému se přidá další položka obsahující pouze čísla
    a určující pozici v rámci rodičovského menu
  FULLNAME ... jméno akce navěšené na položku menu, u koncových položek musí být
    z číselníku `c_pytis_menu_actions', u podmenu a separátorů NULL
  HELP ... nápověda k položce nebo NULL
  HOTKEY ... sekvence hotkeys oddělených mezerami, např. `Alt-a a', mezerník se
    zapisuje jako `SPC'
  LOCKED .. boolean flag udávající, že položka menu není editovatelná správcem
    menu (používá se obvykle jen pro systémové menu)


* genmenu

Nástroj genmenu slouží jednak k importu menu a práv při převodu aplikace na
dynmamická menu a práva a jednak ke kontrolám a aktualizacím dynamických práv
vůči statickým specifikacím.

Genmenu se volá takto:

  tools/genmenu.py DEF_DIR

kde DEF_DIR je adresář obsahující specifikace aplikace.  Kromě toho se obvykle
genmenu dalšími volbami předávají parametry spojení do databáze, viz
`tools/genmenu.py --help'.

Genmenu má několik režimů práce:

  standardní, bez specifických voleb příkazové řádky :: Importuje menu a
    specifikace do databáze.  Jsou-li již v databázi dynamická menu a práva,
    jsou smazána a poté znovu naimportována.

  --delete :: Kompletně vymaže dynamická menu a práva z databáze.

  --check :: Kontroluje dynamická práva v databázi vůči specifikacím aplikace.
    Zjištěné rozdíly jsou vypisovány na řádcích uvozených prefixem =Check:=.

  --check-update :: Stejné jako =--check=, ale navíc vypisuje některé SQL příkazy
    potřebné k aktualizaci dynamických práv ze specifikací.  Tyto řádky jsou
    uvozeny prefixem =Update:=.

Vypisovaná hlášení genmenu se dělí do několika skupin podle prefixů
vypisovaných řádků:

  Error: :: Došlo k chybové situaci, většinou při importu specifikací, kterou
    je nutno napravit.  Buď změnou ve specifikacích aplikace, nebo implementací
    nového rysu do genmenu.

  Warning: :: Upozornění na situaci, která může a nemusí znamenat chybný import
    menu a práv.

  Note: :: Informace o nějakém zjištění, které za normálních okolností
    neznamená chybu, ale přesto je dobré ho zkontrolovat.

  Check: :: Nalezená nesrovnalost při kontrole dynamických práv v databázi vůči
    statickým specifikacím aplikace.  Vypisovánou pouze při použití volby
    =--check=.

  Update: :: SQL příkaz potřebný ke sladění dynamických práv v databázi a
    statických specifikací.  Vypisováno pouze při použití volby =--check-update=.

  bez prefixu :: Hlášky o tom, co genmenu právě dělá.

** Vysvětlení některých hlášení genmenu

Chybová a varovná hlášení:

  Special menu item action, define command specification :: Akce menu
    používající neobvyklé argumenty, které genmenu není schopno zpracovat.
    Řešením je definovat akci jako příkaz v souboru =defs/commands.py=.

  Unexpected `enabled' value :: Argument =enabled= položky menu definované
    prostřednictvím funkce =run_procedure_mitem= má hodnotu, jakou genmenu neumí
    zpracovat.

  Procedure with unhandled `enabled' :: Argumenty položky menu definované
    prostřednictvím funkce =run_procedure_mitem= mají kombinace hodnot, které
    genmenu neumí zpracovat.

  Unknown menu item :: Položka menu neznámého typu.  Zpracování tohoto typu
    položek je nutno v genmenu doimplementovat.

  Unhandled obsolete form specification :: Specifikace formuláře ve tvaru, jaký
    by se již ve specifikacích neměl vyskytovat.  Nutno opravit ve
    specifikacích aplikace.

  Couldn't get access rights for form :: Nelze zjistit přístupová práva daného
    formuláře, přestože by to být možné mělo.

  is_in_groups called in %s for groups %s :: Ve specifikacích je používáno
    volání funkce =is_in_groups= a genmenu místo něho použilo svůj wrapper,
    protože není možné při importu obecných specifikací zohledňovat přihlášení
    konkrétního uživatele.  Specifikace používající =is_in_groups= mohou být
    naimportovány chybně.

  Failed to retrieve RUN_FORM command :: Akce =RUN_FORM= specifikuje příkaz,
    ten však nebyl nalezen.  Akce je ignorována.

  Module not loaded :: Při prohledávání všech specifikací v definičních
    souborech aplikace se nepodařilo naimportovat uvedený modul.  Jeho obsah je
    ignorován.

  Actions without met specifications :: K uvedeným akcím nebyly nalezeny
    specifikace.  Případná přístupová práva nebyla naimportována.

  Not caring about access rights of form :: Speciální typ formuláře, u kterého
    genmenu neumí zjistit přístupová práva a ani nepředpokládá, že by nějaká
    přístupová práva mít měl.

  No access rights specified for form %s, assuming everything permitted ::
    Formulář bez specifikace přístupových práv.

  Non-form action, no rights assigned :: Jiná než formulářová akce, genmenu
    předpokládá, že pro takové akce nejsou specifikována přístupová práva.

Hlášení kontrol:

  Extra action :: Akce je v databázi, ale ne ve specifikacích.  Může jít o již
    nepoužívanou akci nebo nově definovanou akci v databázi.

  Missing action :: Akce je ve specifikacích, ale ne v databázi.  Může jít
    o novou akci, která ještě není v databázi, nebo o akci, která byla
    v databázi zrušena.

  Missing action rights :: Akce má nastavena práva ve specifikacích, ale ne
    v databázi.  Může jít o novou akci, která ještě není v databázi, nebo
    o akci, která byla v databázi zrušena, nebo o vymazání práv akce
    v databázi.

  Missing action title in :: Akce nemá v databázi uvedený název.  Je vhodné ho
    doplnit.

  Missing group rights :: Ve specifikacích jsou uvedena práva akce pro danou
    skupinu, ale v databázi pro tuto skupinu chybí.  Buď jde o nová práva ve
    specifikacích, nebo o změněná práva v databázi.

  Missing permission :: Ve specifikacích jsou uvedena práva akce pro danou
    skupinu, ale v databázi pro tuto skupinu chybí.  Buď jde o nová práva ve
    specifikacích, nebo o změněná práva v databázi.

  Subactions mismatch :: Seznamy podformulářů jsou v databázi a specifikacích
    odlišné.  Buď jde o změnu ve specifikacích, nebo o změnu v databázi,
    případně je potřeba tyto akce do databáze přidat při přechodu ze starší
    verze DMP.

  Multiple permission in the database :: Uvedené právo se v databázi vyskytuje
    duplicitně.  Duplicitní záznamy by měly z databáze vymazány, jinak se
    zobrazují správci DMP v rozpisech práv.

  Different column sets :: Uvedené právo má odlišný seznam sloupců v databázi a
    ve specifikacích.  Jde o změnu práv buď ve specifikacích, nebo v databázi.
